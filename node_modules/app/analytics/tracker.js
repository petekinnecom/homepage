"use strict";

var ga = null;
var queue = [];
var lastPage = '';

var pageView = function(){
  if (window.location.href == lastPage){
    return;
  }

  lastPage = window.location.href;

  var event = 'pageview';
  queue.push(event);
  flushQueue();
};

var getSessionKey = function(){

  if (localStorage.getItem('sessionKey')){
    return localStorage.getItem('sessionKey');
  }
  else {
    var ridiculousUUIDimplentation = Math.random().toString().slice(2);
    localStorage.setItem('sessionKey', ridiculousUUIDimplentation);
    return ridiculousUUIDimplentation;
  }
};

//example event:
//  'hitType': 'event',          // Required.
//  'eventCategory': 'button',   // Required.
//  'eventAction': 'click',      // Required.
//  'eventLabel': 'nav buttons', // Optional
//  'eventValue': 4              // Optional
//

var event = function(e){
  e.hitType = 'event';
  e.eventLabel = getSessionKey();
  queue.push(e);
  flushQueue();
};

var flushQueue = function(){
  window.ga = function(){};
  queue.forEach(function(e){
    window.ga('send', e);
  });
};

//Get this working...
window.registerGoogleAnalytics = function(){
  flushQueue();
};

module.exports = {
  pageView: pageView,
  event: event,
};
