var terminal = require('app/terminal/model');
var $ = require('jquery');
var escape = require('app/utils/regex_escape');
window.$ = $;

var ENTER_KEY = 13;

function View($el, $hidden){

  $el.on('focus', function(event){
    event.preventDefault();
    $hidden.focus();
  });

  $hidden.on('keyup', function(event){
    setCaret($el, $hidden);

    if (event.keyCode === ENTER_KEY) {
      event.preventDefault();
      process($el, $hidden);
    }
  });

  $hidden.on('keydown', function(event){
    setCaret($el, $hidden);
  });

}

var process = function($el, $hidden) {
  terminal.input($hidden.text());
  $el.text('');
  $hidden.text('');
  $hidden.focus();
  setCaret($el, $hidden);
};

var setCaret = function($el, $hidden) {
  var preCaret, underCaret, postCaret,
  $pre, $under, $post,
  regex, match, currentText, newText;
  
  preCaret = getStringBeforeCaret($hidden[0]);
  regex = new RegExp('^' + escape(preCaret) + '(.)?(.*)');

  currentText = $hidden[0].innerText;

  match = currentText.match(regex);

  if (!match) { throw { message: "can't find preCaret string :(" }; }

  underCaret = match[1];
  postCaret = match[2] || '';

  $pre = $('<span></span>');
  $pre.text(preCaret);

  $under = $('<span class="caret"></span>');
  if (underCaret){
    $under.text(underCaret);
  }
  else {
    $under.html('&nbsp;');
  }

  $post = $('<span></span>');
  $post.text(postCaret);

  $el.html([$pre, $under, $post]);

};

var getStringBeforeCaret = function(el){
  var selection, range;

  selection = window.getSelection();
  if (selection.rangeCount > 0) {
      range = selection.getRangeAt(0).cloneRange();
      range.collapse(true);
      range.setStart(el, 0);
      return range.toString();
  }

  console.log("I don't know how you got here");

  throw {
    message: "I don't know how you got here"
  };
};

module.exports = View;
