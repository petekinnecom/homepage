var Model = require('app/articles/model');
var $ = require('jquery');

function Downloader(name){
  this.name = name;
  this.state = 'pending';
  this.deferred = $.Deferred();
  this.promise = this.deferred.promise();
}

Downloader.prototype.download = function(){
  this.state = 'downloading';
  load(this);
  return this.promise;
};

Downloader.prototype.getArticle = function(){
  if (this.state === 'pending'){
    this.download();
  }

  return this.promise;
};

var load = function(article){
  return $.ajax({
    method: 'GET',
    url: 'articles/chunks/' + article.name + '.html'
  })
  .then(function(data){

    var model = Model.create({
      body: data,
    });

    article.state = 'finished';
    article.deferred.resolve(model);

  });
};

module.exports = Downloader;
