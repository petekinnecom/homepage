var Model = require('app/pages/model');
var $ = require('jquery');

function Downloader(page){
  this.page = page;
  this.state = 'pending';
  this.deferred = $.Deferred();
  this.promise = this.deferred.promise();
}

Downloader.prototype.download = function(){
  this.state = 'downloading';
  load.call(this);
  return this.promise;
};

Downloader.prototype.getPage = function(){
  if (this.state === 'pending'){
    this.download();
  }

  return this.promise;
};

var load = function(downloader){
  return $.ajax({
    method: 'GET',
    url: this.page.path
  })
  .then(resolve.bind(this));
};

var resolve = function(data){
  var model = Model.create({
    body: data,
  });

  this.state = 'finished';
  this.deferred.resolve(model);
};

module.exports = Downloader;
